# テーブル設計

## 前提
- DB: PostgreSQL（Supabase）
- 主キー: UUID
- 文字列制限はチェック制約で担保

## rooms
| カラム | 型 | 制約 | 説明 |
| --- | --- | --- | --- |
| id | uuid | PK, default gen_random_uuid() | ルームID |
| name | text | NOT NULL, UNIQUE | ルーム名 |
| password_hash | text | NOT NULL | パスワードハッシュ |
| max_players | int | NOT NULL, CHECK 2-20 | 最大人数 |
| rounds_total | int | NOT NULL, CHECK 1-20 | ラウンド数 |
| round_time_sec | int | NOT NULL, CHECK 30-300 | 制限時間（秒） |
| status | room_status | NOT NULL | lobby/in_progress/finished |
| host_user | uuid | NOT NULL | ホストの auth.uid() |
| created_at | timestamptz | NOT NULL | 作成日時 |
| updated_at | timestamptz | NOT NULL | 更新日時 |

## room_members
| カラム | 型 | 制約 | 説明 |
| --- | --- | --- | --- |
| id | uuid | PK, default gen_random_uuid() | メンバーID |
| room_id | uuid | FK rooms(id) | ルームID |
| user_id | uuid | NOT NULL | auth.uid() |
| username | text | NOT NULL, CHECK 1-16 | 表示名 |
| is_host | boolean | NOT NULL | ホスト判定 |
| joined_at | timestamptz | NOT NULL | 参加日時 |
| left_at | timestamptz | NULL | 退出日時 |

制約/インデックス
- UNIQUE (room_id, user_id)
- UNIQUE (room_id, username)

## prompts
| カラム | 型 | 制約 | 説明 |
| --- | --- | --- | --- |
| id | uuid | PK, default gen_random_uuid() | お題ID |
| word | text | NOT NULL, UNIQUE | お題文字列 |
| category | text | NULL | カテゴリ |
| is_active | boolean | NOT NULL | 有効フラグ |

## rounds
| カラム | 型 | 制約 | 説明 |
| --- | --- | --- | --- |
| id | uuid | PK, default gen_random_uuid() | ラウンドID |
| room_id | uuid | FK rooms(id) | ルームID |
| number | int | NOT NULL | ラウンド番号 |
| drawer_member_id | uuid | FK room_members(id) | 出題者 |
| prompt_id | uuid | FK prompts(id) | お題ID |
| status | round_status | NOT NULL | pending/active/ended/skipped |
| started_at | timestamptz | NULL | 開始時刻 |
| ended_at | timestamptz | NULL | 終了時刻 |

制約/インデックス
- UNIQUE INDEX (room_id, number)

## guesses
| カラム | 型 | 制約 | 説明 |
| --- | --- | --- | --- |
| id | uuid | PK, default gen_random_uuid() | 回答ID |
| room_id | uuid | FK rooms(id) | ルームID |
| round_id | uuid | FK rounds(id) | ラウンドID |
| member_id | uuid | FK room_members(id) | 回答者 |
| content | text | NOT NULL | 回答内容 |
| is_correct | boolean | NOT NULL | 正解判定 |
| awarded_points | int | NOT NULL | 付与ポイント |
| created_at | timestamptz | NOT NULL | 作成日時 |

制約/インデックス
- INDEX (round_id, created_at)

## profiles
| カラム | 型 | 制約 | 説明 |
| --- | --- | --- | --- |
| user_id | uuid | PK, FK auth.users(id) | ユーザーID |
| username | text | NOT NULL, UNIQUE | 表示名 |
| created_at | timestamptz | NOT NULL | 作成日時 |
| updated_at | timestamptz | NOT NULL | 更新日時 |

## game_sessions
| カラム | 型 | 制約 | 説明 |
| --- | --- | --- | --- |
| id | uuid | PK, default gen_random_uuid() | セッションID |
| room_id | uuid | NULL | ルームID（任意） |
| room_name | text | NOT NULL | 部屋名 |
| host_user_id | uuid | NOT NULL | ホストの auth.uid() |
| rounds_total | int | NOT NULL | ラウンド数 |
| round_time_sec | int | NOT NULL | 制限時間（秒） |
| started_at | timestamptz | NOT NULL | 開始日時 |
| ended_at | timestamptz | NULL | 終了日時 |

## game_participants
| カラム | 型 | 制約 | 説明 |
| --- | --- | --- | --- |
| session_id | uuid | FK game_sessions(id) | セッションID |
| user_id | uuid | FK auth.users(id) | ユーザーID |
| username_at_time | text | NOT NULL | 当時の表示名 |
| is_host | boolean | NOT NULL | ホスト判定 |
| score | int | NOT NULL | スコア |
| joined_at | timestamptz | NOT NULL | 参加日時 |
| left_at | timestamptz | NULL | 退出日時 |

制約/インデックス
- UNIQUE (session_id, user_id)

## round_snapshots
| カラム | 型 | 制約 | 説明 |
| --- | --- | --- | --- |
| id | uuid | PK, default gen_random_uuid() | スナップショットID |
| session_id | uuid | FK game_sessions(id) | セッションID |
| round_number | int | NOT NULL | ラウンド番号 |
| drawer_user_id | uuid | FK auth.users(id) | 出題者 |
| prompt_id | uuid | FK prompts(id) | お題ID |
| prompt_word | text | NOT NULL | お題文字列 |
| image_url | text | NOT NULL | Storage URL |
| correct_user_id | uuid | FK auth.users(id) | 正解者 |
| correct_answer | text | NULL | 正解内容 |
| created_at | timestamptz | NOT NULL | 作成日時 |
