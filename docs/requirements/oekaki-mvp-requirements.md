# オンラインお絵描きあてバトル 要件定義書（MVP）

作成日: 2025-11-01
最終更新: 2025-11-03（実装同期）
対象: MVP v1.0（ログインなし / 日本語UI）

---

## 1. 目的・背景

複数人がリアルタイムで参加し、出題者が描く絵を回答者が当てる対戦型Webアプリを短期間で構築する。ログイン機能は持たず、ルーム（部屋）単位の一時的な体験を提供する。バックエンド/DBは Supabase、フロントは Next.js（Netlify デプロイ）を採用する。

---

## 2. 用語定義

- ルーム: ゲームを行うための仮想空間。部屋名 + パスワードで入室。最大10名。
- 出題者: システムからお題を配られ、お絵描きを行う参加者。
- 回答者: 出題者の描画を見てお題を当てる参加者。
- ラウンド: 1名の出題者に対し、制限時間内に回答者が回答する一連の流れ。
- ゲーム: 複数ラウンドで構成される1回の対戦。

---

## 3. スコープ

### 3.1 対象範囲（MVP）

- ルーム作成／入室／退室（部屋名・パスワード・ユーザー名の入力）
- 参加者管理（2〜10名）
- 出題者の割り当て（ランダム。一巡するまでは重複なし）
- お題の配布（出題者のみに表示）
- キャンバス描画（ストローク同期）
- 回答入力（チャット欄＝回答欄）と判定
- スコアリング（最速正解者＋出題者に得点）
- タイマー／制限時間管理（UI: 1/2/3/4/5分＝60/120/180/240/300秒／DB: 30〜300秒）
- ラウンド進行（UI: 1〜10ラウンド／DB: 1〜20ラウンド）
- ログイン無し（ユーザー名のみ）

### 3.2 非対象（将来）

- アカウント/本格認証、フレンド機能
- 外部ストレージへの描画保存/ギャラリー
- ボイスチャット
- ランク/マッチング
- 不正対策/モデレーション全般（MVPでは実施しない）

---

## 4. 画面要件（UI）

### 4.1 トップ

- 「部屋を作成」「部屋に入る」ボタン

### 4.2 部屋作成ダイアログ

- 入力: 部屋名（必須, 2〜24文字）, パスワード（必須, 4〜16文字）, ユーザー名（必須, 1〜16文字）
- 作成後: 待機ロビーへ遷移（作成者がホストとなる）
- オプション: ラウンド数（1〜10）、制限時間（1/2/3/4/5分）

### 4.3 入室ダイアログ

- 入力: 部屋名, パスワード, ユーザー名
- バリデーション/エラー表示（部屋なし/満員/パスワード不一致/重複ユーザー名）

### 4.4 待機ロビー

- 参加者一覧（ユーザー名, ホスト表示）
- ステータス: 現在の人数 / 開始可否（UIは明示チェック無し。実務上は2名以上で開始推奨）
- ルーム設定（出題順: 自動=ランダム一巡, ラウンド数=1〜10, 制限時間=1/2/3/4/5分）※ホストのみ（DBは最大20ラウンド/300秒を許容）
- 「ゲーム開始」ボタン（ホスト）

### 4.5 ゲーム画面

- 左: 描画キャンバス（出題者のみ描画可能。回答者は閲覧）
- 右: タイマー、問題数/ラウンド数、参加者スコア一覧、 お題の文字数（回答者にのみ表示）
- 下: チャット欄（回答専用）
- ステータス表示: 出題者か回答者の役割、現在ラウンド
- システムメッセージ領域（正解通知、残り時間等）
- 管理系: ゲーム開始/終了（ホスト）

### 4.6 リザルト/スコアボード

- 総合順位とスコア（`v_room_scores`）
- 「もう一度遊ぶ」（同じ部屋設定で新規ゲーム）/「部屋を閉じる」（ホスト）

---

## 5. 機能要件

### 5.1 ルーム

- 作成: ユニークな部屋名 + パスワードで生成。存在重複は不可。
- 入室: 10人未満のみ可。
- 退室: 自由。ホストが退室/終了した場合はルーム自体が削除される。
- ホスト: ルーム作成者をホストとし、開始/終了/設定変更を付与。

### 5.2 プレイヤー

- ユーザー名入力（1〜16文字）
- 役割: 出題者/回答者をラウンド毎に割当。ランダムだが一巡完了まで重複選出なし

### 5.3 お題

- ソース: システム辞書（DB「prompts」）。カテゴリ任意。
- 表示: 出題者にのみ文字列を表示。他参加者には非表示（文字数のみ提供）。

### 5.4 描画

- キャンバス: HTML Canvas 2D（モバイル対応）
- ツール: ペン、消しゴム、太さ、 一手戻る、クリア（全消し）
- 同期: Supabase Realtime チャンネル（broadcast/self:true）でストローク差分配信
- 永続化: しない（ページ内のローカルバッファのみ）

### 5.5 回答/判定

- 入力: チャット欄＝回答欄（自由チャットは無し）
- 判定: 完全一致（normalize: trim + lower）。かな/漢字の揺れ吸収は未実装
- 正解時: サーバー側トリガで即座に `advance_round` 実行（状態はRealtimeで反映）。UIは5秒結果表示

### 5.6 スコアリング

- 回答者: 最速正解者 +5点
- 出題者: 制限時間内に正解者がいたら +3点
- 未正解: 得点なし

### 5.7 タイマー/進行

- ラウンド制限時間: UIは 1/2/3/4/5 分（=60/120/180/240/300 秒）。DB制約は 30〜300 秒
- 準備時間: なし（active 遷移時に started_at 設定、即カウント）
- インターバル: 5秒（正解/時間切れ後に表示）
- ラウンド数: UIは 1〜10。DB制約は 1〜20
- ゲーム終了: すべてのラウンドが終了すると `rooms.status = 'finished'`

### 5.8 エラー/離脱時の取り扱い

- 出題者離脱: 今後の拡張対象（現状はホストによる終了/再開でリカバリ）
- ホスト離脱: ルーム削除（トリガ）。参加者は退出状態
- 通信断: 復帰時に最新状態へ同期（ラウンド/スコア）

---

## 6. 非機能要件

- 対応環境: 最新版 Chrome/Edge/Safari/Firefox
- パフォーマンス: 10人同時接続でラウンド中の描画遅延 < 150ms（国内リージョン想定）
- 可用性: 稼働率 99%/月（MVP目標）
- セキュリティ: ルーム鍵（パスワード）必須、TLS、RLS（Row Level Security）
- アクセシビリティ: キーボード操作、コントラスト比準拠（WCAG AA 目標）

## 7. システム構成

- フロント: Next.js（Netlify）
- バックエンド/DB: Supabase（PostgreSQL, Realtime, Edge Functions）
- 通信: Supabase Realtime（WebSocket）でルーム毎のチャンネル
- 画像保存: なし（MVP）
- 監視: Netlify Logs, Supabase Logs

環境変数（フロント）

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

---

## 8. データモデル概要（Supabase / PostgreSQL）

> すべて RLS 有効。room_id 等は uuid。定義は `supabase/sql/000_init_oekaki_battle.sql` を参照。

- rooms: ルーム本体（status: lobby/in_progress/finished、host_user、round_time_sec, rounds_total）
- room_members: ルーム参加者（left_at で退出管理、ホスト行削除でルーム削除）
- prompts: お題辞書（word, category, is_active）
- rounds: ラウンド（drawer_member_id, prompt_id, status, started_at, ended_at）
- guesses: 回答ログ（is_correct, awarded_points）
- v_room_scores: スコアビュー（回答点 + 出題者ボーナスを合算）

---

## 9. バリデーション/エラー仕様

- 部屋作成: name 重複→409、形式不備→400
- 入室: 404（部屋なし）, 403（パス誤り）, 409（満員/重複ユーザー名）
- 進行: 権限無し→403/400、その他DBエラーはメッセージ表示
- 入力制限: ユーザー名1〜16、部屋名2〜24、パスワード4〜16

---

## 10. セキュリティ

- パスワードはハッシュ保存（pgcrypto/crypt）
- RLS: ルーム/メンバー/ラウンド/回答でスコープ制限。ホストのみ更新可能領域あり
- XSS/CSRF: 基本対策（Next.jsのデフォルト + 入力制限）

---

## 11. ログ/監視/運用

- 監視: Netlify deploy logs, Supabase Realtime/DB logs
- 主要メトリクス: 同接数、平均レイテンシ、正解率、切断率
- エラーレポート: コンソールエラー収集（Sentry等は将来）
- データ保持: 描画ストロークは非永続。終了操作（`end_game`）でルーム削除

---

付記（現状実装の補足）

- 正解が発生すると DB トリガで自動的に `advance_round` が呼ばれ、即時で次ラウンド/終了に遷移します。フロントは 5 秒の結果表示後に状態を再取得します。
- リザルト画面は `rooms.status = 'finished'` の間に表示されます。ホストが「部屋を閉じる」操作（`end_game`）を行うとルームは削除されトップに戻ります。
- 描画は Supabase Realtime チャンネルで同期（broadcast/self:true）。ペン/消しゴム/太さ/一手戻る/全消しをサポートします。
