# オンラインお絵描きあてバトル 要件定義書（初版）

作成日: 2025-11-01
対象: MVP v1.0（ログインなし / 日本語UI）

---

## 1. 目的・背景

複数人がリアルタイムで参加し、出題者が描く絵を回答者が当てる対戦型Webアプリを短期間で構築する。ログイン機能は持たず、ルーム（部屋）単位の一時的な体験を提供する。バックエンド/DBは Supabase、フロントは Netlify を採用する。

---

## 2. 用語定義

* **ルーム**: ゲームを行うための仮想空間。部屋名 + パスワードで入室。最大10名。
* **出題者**: システムからお題を配られ、お絵描きを行う参加者。
* **回答者**: 出題者の描画を見てお題を当てる参加者。
* **ラウンド**: 1名の出題者に対し、制限時間内に回答者が回答する一連の流れ。
* **ゲーム**: 複数ラウンドで構成される1回の対戦。

---

## 3. スコープ

### 3.1 対象範囲（MVP）

* ルーム作成／入室／退室（部屋名・パスワード・ユーザー名の入力）
* 参加者管理（3〜10名）
* 出題者の割り当て（ランダム。ただし一巡するまでは重複なし）
* お題の配布（出題者のみに表示）
* キャンバス描画（ストローク同期）
* 回答入力（チャット欄＝回答欄）と判定
* スコアリング（最速正解者＋出題者に得点）
* タイマー／制限時間管理（30〜120秒を部屋作成時に設定）
* ラウンド進行（3〜20ラウンドを部屋作成時に設定）
* ログイン無し（ユーザー名のみ）

### 3.2 非対象（将来）

* アカウント/本格認証、フレンド機能
* 外部ストレージへの描画保存/ギャラリー
* ボイスチャット
* ランク/マッチング
* 不正対策/モデレーション全般（MVPでは実施しない）
* アカウント/本格認証、フレンド機能
* 外部ストレージへの描画保存/ギャラリー
* ボイスチャット
* ランク/マッチング

---

## 4. 画面要件（UI）

### 4.1 トップ

* 「部屋を作成」「部屋に入る」ボタン

### 4.2 部屋作成ダイアログ

* 入力: 部屋名（必須, 2〜24文字）, パスワード（必須, 4〜16文字）, **ユーザー名**（必須, 1〜16文字）
* 作成後: 待機ロビーへ遷移（作成者がホストとなる）

### 4.3 入室ダイアログ

* 入力: 部屋名, パスワード, **ユーザー名**
* バリデーション/エラー表示（部屋なし/満員/パスワード不一致）

### 4.4 待機ロビー

* 参加者一覧（ユーザー名, 回線状態）
* ステータス: 現在の人数 / 開始可否（3〜10名で「ゲーム開始」活性）
* ルーム設定（出題順: 自動=ランダム一巡, ラウンド数=3〜20, 制限時間=30/60/90/120秒）※ホストのみ
* 「ゲーム開始」ボタン（ホスト）

### 4.5 ゲーム画面

* 左: 描画キャンバス（出題者のみ描画可能。回答者は閲覧）
* 右: タイマー、問題数/ラウンド数、参加者スコア一覧、**お題の文字数（回答者にのみ表示）**
* 下: **チャット欄（回答専用）**
* ステータス表示: 出題者名、現在ラウンド
* システムメッセージ領域（正解通知、残り時間等）
* 管理系: スキップ（ホスト）

### 4.6 リザルト/スコアボード

* 総合順位、各ラウンドの正解時刻、出題者得点
* 「もう一度遊ぶ」「ロビーへ戻る」

---

## 5. 機能要件

### 5.1 ルーム

* 作成: ユニークな部屋名 + パスワードで生成。存在重複は不可。
* 入室: 10人未満のみ可。観戦者モード（将来）除外。
* 退室: 自由。出題者が退室した場合の代替ルール（後述）。
* ホスト: ルーム作成者をホストとし、開始/設定変更を付与。
* ゲスト: ホスト以外の参加者のこと。
* 部屋: ホストがその部屋から抜け出した場合、テーブルから部屋情報を削除する。その部屋に参加していたゲストは自動で部屋から抜け出す。

### 5.2 プレイヤー

* ユーザー名入力（1〜16文字）
* 役割: 出題者/回答者をラウンド毎に割当。**ランダムだが一巡完了まで重複選出なし**（各サイクルでシャッフル）

### 5.3 お題

* ソース: システム辞書（DB「prompts」）。カテゴリは「動物/食べ物/日用品/アクション…」
* 表示: 出題者にのみ固定パネルで表示、他参加者には非表示
* **ヒント機能: なし（MVP）**
* **回答者にはお題の文字数のみ表示**（基準は `prompts.text` の文字数）

### 5.4 描画

* キャンバス: HTML Canvas 2D（モバイル対応）
* ツール: ペン、消しゴム、太さ、クリア（全消しはホスト/出題者のみ）
* 同期: Realtime（Supabase Realtime チャンネル）でストローク差分配信
* 帯域削減: ストロークの間引き/バッチ送信、再送/復元

### 5.5 回答/判定

* 入力: **チャット欄＝回答欄**（自由チャットは無し）
* 判定: **完全一致**。ただし、漢字、ひらがな、かたかなの揺らぎは吸収する。例えばお題が「海の家」なら、「海の家」、「うみのいえ」、「うみの家」、「海のいえ」でも正解とする。
* 正解決定: 最初に正解した回答者を確定し、以降の回答は無効

### 5.6 スコアリング

* 回答者: 最速正解者に **+10点**
* 出題者: 正解が出た場合 **+5点**（誰も当てられない場合 0点）
* 同時正解: タイムスタンプ同値は同着扱い（MVPは全員 +10点）
* ラウンド未正解: だれも正解できなければ得点なし

### 5.7 タイマー/進行

* ラウンド制限時間: **30〜120秒の範囲で設定**（部屋作成時。デフォルト 60秒）
* 準備時間: 10秒（お題確認/描画開始）
* インターバル: 5秒（結果表示→次ラウンド）
* ラウンド数: **3〜20**（部屋作成時。デフォルト 5）

### 5.8 エラー/離脱時の取り扱い

* 出題者離脱: 10秒待機後にラウンドスキップ、次の出題者へ
* ホスト離脱: 次の入室順にホスト委譲
* 通信断: 30秒未操作でタイムアウト表示、復帰時は最新状態同期

---

## 6. 非機能要件

* **対応環境**: 最新版 Chrome/Edge/Safari/Firefox
* **パフォーマンス**: 10人同時接続でラウンド中の描画遅延 < 150ms（国内リージョン）
* **可用性**: 稼働率 99%/月（MVP目標）
* **セキュリティ**: ルーム鍵（パスワード）必須、TLS、RLS（Row Level Security）
* **アクセシビリティ**: キーボード操作、コントラスト比準拠（WCAG AA 目標）

## 7. システム構成

* **フロント**: Netlify（next.js）、Vite ビルド
* **バックエンド/DB**: Supabase（PostgreSQL, Realtime, Edge Functions）
* **通信**: Supabase Realtime（WebSocket）でルーム毎のチャネル。
* **画像保存**: MVPでは保存しない（将来: Supabase Storage）
* **監視**: Netlify Logs, Supabase Logs（SQL/Realtime）

環境変数（例）

* `VITE_SUPABASE_URL`
* `VITE_SUPABASE_ANON_KEY`
* `VITE_APP_REGION`（表示用）

---

## 8. データモデル（Supabase / PostgreSQL）

> すべて RLS 有効。room_id 等は `uuid`。

---

## 9. バリデーション/エラー仕様

* 部屋作成: name 重複→エラー、パス形式不備→エラー、ユーザー名形式不備→エラー
* 入室: 404（部屋なし）, 403（パス誤り）, 409（満員）, 409（ユーザー名重複）
* 進行: 開始条件未達（422）、出題者離脱→自動スキップ
* 入力制限: 文字数1〜32
---

## 10. セキュリティ

* パスワードはハッシュ保存（Argon2）
* RLS で room_id スコープに限定
* XSS/CSRF 基本対策
---

## 11. ログ/監視/運用

* 監視: Netlify deploy logs, Supabase Realtime/DB logs
* 主要メトリクス: 同接数、平均レイテンシ、正解率、切断率
* エラーレポート: コンソールエラー収集（Sentry等は将来）
* データ保持: ゲーム終了後の詳細データは 24h 保存（MVP）。PIIはニックネームのみ
---

## 12. 受け入れ基準（抜粋）

* 3〜10人でゲームを開始できる
* **部屋作成/入室時に部屋名・パスワード・ユーザー名を入力する**
* 最速正解者と出題者に得点が入る
* 制限時間内に正解が出なければ誰にも点が入らない
* 出題者にのみお題が見える（回答者には文字数のみが表示される）
* 10人満員の部屋には入室できない
* ログインせずにプレイ可能
* **正解判定は完全一致(揺らぎ吸収)**
* **出題者は一巡するまで重複選出されない**
* **ラウンド数は3〜20、制限時間は30〜120秒の範囲で設定できる**
---


## 13. リスク/課題

* Realtimeの遅延/切断（回線品質依存）
* 正解ゆらぎの設計（曖昧一致の要求増）
* 不適切コンテンツ（描画/テキスト）のモデレーション範囲
* 同時正解の採点ルールの公平性

---

## 付録: UI 文言例

* 正解: 「{name} が正解！お題は『{word}』」
* 残り時間: 「のこり {sec} 秒」
* 入室失敗: 「部屋が存在しない/満員/パスワードが違います」
